/* Copyright 2019 SiFive, Inc */
/* SPDX-License-Identifier: Apache-2.0 */

#include <stdio.h>
#include "hbird_sdk_soc.h"

//#define R 4294967296
#define KYBER_Q 3329
#define QINV  62209

//#define LenN 256
//#define LenN_inv 10446841
//#define LenN_inv_Rfield 6289407
//#define LenN_inv_R2_Rfield 3238609
//#define INV2 5243905

//#define R2_MODP 546993

int16_t matrixA[256]={928,1933,3101,602,2846,480,1066,3156,387,2495,1834,1945,2998,3071,512,2011,1195,3103,2464,1978,1285,1649,3119,1231,2261,1007,2397,407,1858,364,446,1884,2861,250,3035,3017,1275,2580,337,552,1342,3105,822,1701,812,1489,1063,3226,2815,1118,651,2083,1562,1816,2370,2701,1110,2796,2873,622,1175,714,2853,845,323,2314,2853,2344,636,731,406,3211,1353,1247,3097,1425,450,2213,3033,669,1473,2788,2355,1503,1970,564,3066,1315,20,3215,3151,2646,2119,844,908,468,2491,3150,432,42,459,1036,966,2736,664,2235,634,1021,2082,2888,288,1528,558,301,1458,302,2914,672,2537,2128,261,687,2280,1797,550,1065,2141,1992,2579,929,174,2697,2307,3208,458,663,2487,2437,1888,241,402,260,19,2716,2070,1956,1110,2599,2702,840,877,2217,628,3245,1391,2752,2605,1522,2487,2503,3162,413,198,105,881,832,87,1041,1336,975,73,1798,983,981,2711,1697,2223,3002,1954,2826,1160,2118,409,2318,621,1160,408,98,113,947,1297,1285,1133,2211,312,543,1610,919,2832,3276,272,899,1431,986,4,45,1797,423,1462,2917,355,960,3255,1655,949,1728,2660,3185,1852,2510,2110,1570,1009,2585,1508,3058,1304,311,2341,3094,104,641,690,343,179,1953,2860,2892,1650,1590,1024,819,738,2256,2262,867,1099,1422,720,1488,1519,546,2550,3317,1780,933};
int16_t matrixB[256]={928,1933,3101,602,2846,480,1066,3156,387,2495,1834,1945,2998,3071,512,2011,1195,3103,2464,1978,1285,1649,3119,1231,2261,1007,2397,407,1858,364,446,1884,2861,250,3035,3017,1275,2580,337,552,1342,3105,822,1701,812,1489,1063,3226,2815,1118,651,2083,1562,1816,2370,2701,1110,2796,2873,622,1175,714,2853,845,323,2314,2853,2344,636,731,406,3211,1353,1247,3097,1425,450,2213,3033,669,1473,2788,2355,1503,1970,564,3066,1315,20,3215,3151,2646,2119,844,908,468,2491,3150,432,42,459,1036,966,2736,664,2235,634,1021,2082,2888,288,1528,558,301,1458,302,2914,672,2537,2128,261,687,2280,1797,550,1065,2141,1992,2579,929,174,2697,2307,3208,458,663,2487,2437,1888,241,402,260,19,2716,2070,1956,1110,2599,2702,840,877,2217,628,3245,1391,2752,2605,1522,2487,2503,3162,413,198,105,881,832,87,1041,1336,975,73,1798,983,981,2711,1697,2223,3002,1954,2826,1160,2118,409,2318,621,1160,408,98,113,947,1297,1285,1133,2211,312,543,1610,919,2832,3276,272,899,1431,986,4,45,1797,423,1462,2917,355,960,3255,1655,949,1728,2660,3185,1852,2510,2110,1570,1009,2585,1508,3058,1304,311,2341,3094,104,641,690,343,179,1953,2860,2892,1650,1590,1024,819,738,2256,2262,867,1099,1422,720,1488,1519,546,2550,3317,1780,933};
int16_t matrixC[256]={1173,301,2520,865,2833,3087,708,375,167,558,2526,2474,368,879,691,3052,2165,1583,455,202,2794,2481,1334,285,2809,1544,3290,2371,3019,3307,855,2357,1141,611,483,2347,1703,208,2895,2346,1997,601,3021,2084,1704,2188,2165,333,2057,421,2664,3172,1346,3130,3276,71,1948,2538,2024,2515,1848,3323,685,2720,193,2874,68,2261,2842,1014,1567,2710,3172,3208,3120,1150,1113,749,1606,3099,2014,888,2315,2362,452,2182,2402,2319,2469,844,2880,1710,1347,142,536,2263,2868,734,654,2341,2442,2212,2523,2126,1773,2458,824,28,3000,2545,2194,2511,3129,2168,2745,103,2350,1725,1531,248,1347,1796,2435,3097,2003,873,2096,1767,55,2389,963,3100,1453,1493,3066,2329,1781,1673,1555,2889,2825,580,1343,1744,1420,45,900,1803,2381,1355,1184,331,277,1439,3203,3112,2290,217,1906,724,772,1360,2358,1688,2883,3179,3225,2963,2555,830,1199,1684,1732,3175,746,2279,1883,164,1530,800,2387,1939,2730,3143,3260,2086,3278,1159,2202,1563,247,962,718,2349,1459,97,2500,1567,1904,2471,1822,480,458,934,3299,1897,3203,1103,261,1414,3072,770,3298,2249,1709,765,2594,933,1515,2869,509,2858,518,1469,1094,1908,2008,1161,303,870,534,1179,909,1557,2010,1607,1975,1288,617,1478,563,1732,3288,3199,1506,2949,1888,2072,2767,2070,143,877,306,113,1552,920};
int16_t matrixD[256]={181, 1337, 3248, 1364, 2540, 793, 1371, 2228, 481, 45, 2299, 2128, 1559, 114, 1420, 3194, 3188, 1190, 2368, 2270, 530, 3094, 415, 3248, 2587, 2742, 802, 2771, 2280, 3015, 131, 893, 821, 1284, 1765, 262, 2765, 379, 1302, 2777, 2557, 1302, 3135, 719, 833, 1126, 57, 2651, 2346, 407, 2789, 3071, 46, 64, 1764, 2590, 2378, 1676, 2561, 1148, 879, 1191, 2507, 2832, 12, 894, 3318, 2182, 2441, 905, 423, 716, 3001, 1943, 1978, 2139, 515, 95, 3063, 875, 1837, 1909, 2452, 1804, 2543, 2258, 23, 2911, 2727, 1039, 1346, 2101, 1933, 840, 1168, 2465, 3105, 1339, 338, 2264, 2259, 999, 2448, 2404, 2861, 243, 1525, 1379, 2821, 252, 2369, 448, 2984, 1074, 2327, 3026, 1349, 1161, 2139, 1969, 2106, 2071, 1990, 3308, 1692, 2391, 3192, 2022, 1784, 732, 2419, 296, 486, 990, 2180, 2989, 681, 2731, 532, 1123, 486, 1129, 2584, 2203, 2361, 961, 417, 7, 2833, 2156, 1203, 3016, 2385, 308, 3126, 2697, 1390, 2586, 801, 313, 2132, 164, 316, 2408, 1418, 1544, 1446, 705, 2219, 2406, 1001, 1660, 2735, 2111, 173, 2427, 330, 1713, 973, 2979, 568, 846, 1378, 1454, 2003, 2540, 2009, 3257, 958, 892, 2860, 617, 2301, 438, 3097, 1906, 193, 1455, 3124, 2718, 3225, 3171, 777, 2408, 1179, 436, 3167, 1529, 2057, 12, 2522, 2700, 2269, 2029, 2029, 701, 134, 1991, 1621, 3022, 1778, 2115, 1309, 2625, 652, 1498, 3018, 1030, 3295, 2131, 1566, 1978, 13, 1022, 779, 1162, 2867, 1591, 1760, 926, 1292, 2408, 3102, 2431, 2499, 992, 3324, 2101, 693, 2998, 2699, 2265, 2040, 2042, 2606, 459};

const int32_t barrett_const = (1U << 26)/KYBER_Q + 1;
//ROUND 2 zetas for asm fwNTT level 3-1 
int16_t new_zeta_31[112] = {573, 1223, 652, 2226, 430, 555, 843, 2004, 2777, 1015, 2078, 871, 1550, 105, 264, 2036, 1491, 422, 587, 177, 3094, 383, 3047, 1785, 3038, 2869, 1574, 1653, 2500, 516, 3321, 3083, 778, 1159, 3182, 1458, 3009, 2663, 2552, 1483, 2727, 1119, 1727, 1711, 2167, 1739, 644, 2457, 349, 3199, 126, 1469, 418, 329, 3173, 3254, 2648, 2476, 3239, 817, 1097, 603, 610, 1017, 3058, 830, 1322, 2044, 1864, 384, 732, 107, 1908, 2114, 3193, 1218, 1994, 608, 3082, 2378, 2455, 220, 2142, 1670, 1787, 2931, 961, 2144, 1799, 2051, 794, 411, 1821, 2604, 1819, 2475, 2459, 478, 3124, 448, 2264, 3221, 3021, 996, 991, 1758, 677, 2054, 958, 1869, 1522, 1628};
//ROUND 2 omegas for asm invNTT level 1-3 
int16_t new_omega_r2[112] = {1701, 1807, 1460, 2371, 1275, 2652, 1571, 2338, 2333, 308, 108, 1065, 2881, 205, 2851, 870, 854, 1510, 725, 1508, 2918, 2535, 1278, 1530, 1185, 2368, 398, 1542, 1659, 1187, 3109, 874, 951, 247, 2721, 1335, 2111, 136, 1215, 1421, 3222, 2597, 2945, 1465, 1285, 2007, 2499, 271, 2312, 2719, 2726, 2232, 2512, 90, 853, 681, 75, 156, 3000, 2911, 1860, 3203, 130, 2980, 872, 2685, 1590, 1162, 1618, 1602, 2210, 602, 1846, 777, 666, 320, 1871, 147, 2170, 2551, 246, 8, 2813, 829, 1676, 1755, 460, 291, 1544, 282, 2946, 235, 3152, 2742, 2907, 1838, 1293, 3065, 3224, 1779, 2458, 1251, 2314, 552, 1325, 2486, 2774, 2899, 1103, 2677, 2106, 2756};

int16_t zetas[128] = {
  2285, 2571, 2970, 1812, 1493, 1422, 287, 202, 3158, 622, 1577, 182, 962, 2127, 1855, 1468, 
  573, 2004, 264, 383, 2500, 1458, 1727, 3199, 2648, 1017, 732, 608, 1787, 411, 3124, 1758, 
  1223, 652, 2777, 1015, 2036, 1491, 3047, 1785, 516, 3321, 3009, 2663, 1711, 2167, 126, 1469, 
  2476, 3239, 3058, 830, 107, 1908, 3082, 2378, 2931, 961, 1821, 2604, 448, 2264, 677, 2054, 
  2226, 430, 555, 843, 2078, 871, 1550, 105, 422, 587, 177, 3094, 3038, 2869, 1574, 1653, 
  3083, 778, 1159, 3182, 2552, 1483, 2727, 1119, 1739, 644, 2457, 349, 418, 329, 3173, 3254, 
  817, 1097, 603, 610, 1322, 2044, 1864, 384, 2114, 3193, 1218, 1994, 2455, 220, 2142, 1670, 
  2144, 1799, 2051, 794, 1819, 2475, 2459, 478, 3221, 3021, 996, 991, 958, 1869, 1522, 1628};

int16_t zetas_inv[128] = {
  1701, 1807, 1460, 2371, 2338, 2333, 308, 108, 2851, 870, 854, 1510, 2535, 1278, 1530, 1185, 
  1659, 1187, 3109, 874, 1335, 2111, 136, 1215, 2945, 1465, 1285, 2007, 2719, 2726, 2232, 2512, 
  75, 156, 3000, 2911, 2980, 872, 2685, 1590, 2210, 602, 1846, 777, 147, 2170, 2551, 246, 
  1676, 1755, 460, 291, 235, 3152, 2742, 2907, 3224, 1779, 2458, 1251, 2486, 2774, 2899, 1103, 
  1275, 2652, 1065, 2881, 725, 1508, 2368, 398, 951, 247, 1421, 3222, 2499, 271, 90, 853, 
  1860, 3203, 1162, 1618, 666, 320, 8, 2813, 1544, 282, 1838, 1293, 2314, 552, 2677, 2106, 
  1571, 205, 2918, 1542, 2721, 2597, 2312, 681, 130, 1602, 1871, 829, 2946, 3065, 1325, 2756, 
  1861, 1474, 1202, 2367, 3147, 1752, 2707, 171, 3127, 3042, 1907, 1836, 1517, 359, 758, 1441};

//extern void BaseMul(int16_t *,int16_t *, int16_t *, int16_t);

int16_t montgomery_reduce(int32_t a){
	int32_t t;
	int16_t u;

	u = a * QINV;
	t = (int32_t)u * KYBER_Q;
	t = a - t;
	t >>= 16;
	return t;
}

int16_t barrett_reduce(int16_t a){
	int16_t t;
	const int16_t v = ((1U << 26) + KYBER_Q/2)/KYBER_Q;

	t = (int32_t)v*a >> 26;
	t *= KYBER_Q;
	return a - t;
}

static int16_t fqmul(int16_t a, int16_t b){
	return montgomery_reduce((int32_t)a*b);
}

/*************************************************
* Name:        basemul
*
* Description: Multiplication of polynomials in Zq[X]/(X^2-zeta)
*              used for multiplication of elements in Rq in NTT domain
*
* Arguments:   - int16_t r[2]:       pointer to the output polynomial
*              - const int16_t a[2]: pointer to the first factor
*              - const int16_t b[2]: pointer to the second factor
*              - int16_t zeta:       integer defining the reduction polynomial
**************************************************/
void basemul(int16_t *r1,
	     int16_t *r2,
             int16_t a1,
	     int16_t a2,
             int16_t b1,
	     int16_t b2,
             int16_t zeta)
{
  *r1  = fqmul(a2, b2);
  *r1  = fqmul(*r1, zeta);
  *r1 += fqmul(a1, b1);

  *r2  = fqmul(a1, b2);
  *r2 += fqmul(a2, b1);

}

void poly_mul(int16_t r[256],
	      int16_t a[256],
	      int16_t b[256],
	      int16_t zetas[128]
		)
{
	unsigned int i;
	for(i=0;i<64;i++) {
    		basemul(&(r[4*i]),&(r[4*i+1]),a[4*i],a[4*i+1],b[4*i],b[4*i+1], zetas[64+i]);
    		basemul(&(r[4*i+2]),&(r[4*i+3]), a[4*i+2],a[4*i+3], b[4*i+2],b[4*i+3], -zetas[64+i]);
  		}

}

void poly_reduce(int16_t r[256])
{
	int i;
	for(i=0; i<256; i++){
		r[i] = barrett_reduce(r[i]);
	}
}

/*void poly_mul(int16_t r[256],
			  int16_t a[256],
			  int16_t b[256],
			  int16_t zetas[128]
		  )
{
	unsigned int i;
	for(i=0;i<64;i++){
		int16_t A0[2] = {a[4*i],a[4*i+1]};
		int16_t B0[2] = {b[4*i],b[4*i+1]};
		int16_t r0[2] = {r[4*i],r[4*i+1]};
		int16_t A1[2] = {a[4*i+2],a[4*i+3]};
		int16_t B1[2] = {b[4*i+2],b[4*i+3]};
		int16_t r1[2] = {r[4*i+2],r[4*i+3]};
		BaseMul(r0,A0,B0,zetas[64+i]);
		BaseMul(r1,A1,B1,-zetas[64+i]);
		r[4*i] = r0[0];
		r[4*i+1] = r0[1];
		r[4*i+2] = r1[0];
		r[4*i+3] = r1[1];
	}
}*/

void ntt(int16_t r[256]) {
  unsigned int len, start, j, k;
  int16_t t, zeta;

  k = 1;
  for(len = 128; len >= 2; len >>= 1) {
    for(start = 0; start < 256; start = j + len) {
      zeta = zetas[k++];
      for(j = start; j < start + len; ++j) {
        t = fqmul(zeta, r[j + len]);
        r[j + len] = r[j] - t;
        r[j] = r[j] + t;
      }
    }
  }
}

void invntt(int16_t r[256]) {
  unsigned int start, len, j, k;
  int16_t t, zeta;

  k = 0;
  for(len = 2; len <= 128; len <<= 1) {
    for(start = 0; start < 256; start = j + len) {
      zeta = zetas_inv[k++];
      for(j = start; j < start + len; ++j) {
        t = r[j];
        r[j] = barrett_reduce(t + r[j + len]);
        r[j + len] = t - r[j + len];
        r[j + len] = fqmul(zeta, r[j + len]);
      }
    }
  }

  for(j = 0; j < 256; ++j)
    r[j] = fqmul(r[j], zetas_inv[127]);
}


unsigned int begin_twist, begin_ntt_ma, begin_ntt_mb, begin_basemul, begin_intt, begin_i_twist;
unsigned int end_twist, end_ntt_ma, end_ntt_mb, end_basemul, end_intt, end_i_twist;


void main(void){
		int i;
 			
			begin_ntt_ma =__get_rv_cycle();
	    		ntt(matrixA);
			poly_reduce(matrixA);
			end_ntt_ma =__get_rv_cycle();
			printf("cycle_count_ntt(MA) is %d\n", end_ntt_ma - begin_ntt_ma);

			begin_ntt_mb =__get_rv_cycle();
			ntt(matrixB);
			poly_reduce(matrixB);
			end_ntt_mb =__get_rv_cycle();
			printf("cycle_count_ntt(MB) is %d\n", end_ntt_mb - begin_ntt_mb);


			begin_basemul =__get_rv_cycle();
			poly_mul(matrixC,matrixA,matrixB,zetas);
			poly_reduce(matrixC);
			end_basemul =__get_rv_cycle();
			printf("cycle_count_Basemul is %d\n", end_basemul - begin_basemul);


			begin_intt =__get_rv_cycle();
			invntt(matrixC);
			end_intt =__get_rv_cycle();
			printf("cycle_count_INTT is %d\n", end_intt - begin_intt);
			

			printf("******************************************************************\n");
			printf("*********************check_7-1*********************************************\n");
			for(i = 0; i < 256; i++){
				printf("%10d\t%10d,", i,matrixC[i]-matrixD[i]);
				printf("\n");
			}
		//int res; 
		//asm volatile(
		//"lw x10, %[src1]\t\n"
		//"lw x11, %[src2]\t\n"
		//"sub %[dest], x10, x11\t\n"
		//:[dest] "=r" (res)		
		//:[src1]"r"(matrixA[0]),[src2]"r"(matrixB[0])
		//:"x10","x11"
//);
}
