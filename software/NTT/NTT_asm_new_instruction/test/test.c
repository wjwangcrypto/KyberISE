/* Copyright 2019 SiFive, Inc */
/* SPDX-License-Identifier: Apache-2.0 */

#include <stdio.h>
#include "hbird_sdk_soc.h"

//#define R 4294967296
#define OP1 805306416
#define Prime 3329

#define BarrettV 157
#define INV2 512

#define xornum 255
//#define LenN 256
//#define LenN_inv 10446841
//#define LenN_inv_Rfield 6289407
//#define LenN_inv_R2_Rfield 3238609
//#define INV2 5243905

//#define R2_MODP 546993

int16_t matrixA[256]={928,1933,3101,602,2846,480,1066,3156,387,2495,1834,1945,2998,3071,512,2011,1195,3103,2464,1978,1285,1649,3119,1231,2261,1007,2397,407,1858,364,446,1884,2861,250,3035,3017,1275,2580,337,552,1342,3105,822,1701,812,1489,1063,3226,2815,1118,651,2083,1562,1816,2370,2701,1110,2796,2873,622,1175,714,2853,845,323,2314,2853,2344,636,731,406,3211,1353,1247,3097,1425,450,2213,3033,669,1473,2788,2355,1503,1970,564,3066,1315,20,3215,3151,2646,2119,844,908,468,2491,3150,432,42,459,1036,966,2736,664,2235,634,1021,2082,2888,288,1528,558,301,1458,302,2914,672,2537,2128,261,687,2280,1797,550,1065,2141,1992,2579,929,174,2697,2307,3208,458,663,2487,2437,1888,241,402,260,19,2716,2070,1956,1110,2599,2702,840,877,2217,628,3245,1391,2752,2605,1522,2487,2503,3162,413,198,105,881,832,87,1041,1336,975,73,1798,983,981,2711,1697,2223,3002,1954,2826,1160,2118,409,2318,621,1160,408,98,113,947,1297,1285,1133,2211,312,543,1610,919,2832,3276,272,899,1431,986,4,45,1797,423,1462,2917,355,960,3255,1655,949,1728,2660,3185,1852,2510,2110,1570,1009,2585,1508,3058,1304,311,2341,3094,104,641,690,343,179,1953,2860,2892,1650,1590,1024,819,738,2256,2262,867,1099,1422,720,1488,1519,546,2550,3317,1780,933};
int16_t matrixB[256]={928,1933,3101,602,2846,480,1066,3156,387,2495,1834,1945,2998,3071,512,2011,1195,3103,2464,1978,1285,1649,3119,1231,2261,1007,2397,407,1858,364,446,1884,2861,250,3035,3017,1275,2580,337,552,1342,3105,822,1701,812,1489,1063,3226,2815,1118,651,2083,1562,1816,2370,2701,1110,2796,2873,622,1175,714,2853,845,323,2314,2853,2344,636,731,406,3211,1353,1247,3097,1425,450,2213,3033,669,1473,2788,2355,1503,1970,564,3066,1315,20,3215,3151,2646,2119,844,908,468,2491,3150,432,42,459,1036,966,2736,664,2235,634,1021,2082,2888,288,1528,558,301,1458,302,2914,672,2537,2128,261,687,2280,1797,550,1065,2141,1992,2579,929,174,2697,2307,3208,458,663,2487,2437,1888,241,402,260,19,2716,2070,1956,1110,2599,2702,840,877,2217,628,3245,1391,2752,2605,1522,2487,2503,3162,413,198,105,881,832,87,1041,1336,975,73,1798,983,981,2711,1697,2223,3002,1954,2826,1160,2118,409,2318,621,1160,408,98,113,947,1297,1285,1133,2211,312,543,1610,919,2832,3276,272,899,1431,986,4,45,1797,423,1462,2917,355,960,3255,1655,949,1728,2660,3185,1852,2510,2110,1570,1009,2585,1508,3058,1304,311,2341,3094,104,641,690,343,179,1953,2860,2892,1650,1590,1024,819,738,2256,2262,867,1099,1422,720,1488,1519,546,2550,3317,1780,933};
int16_t matrixC[256]={1173,301,2520,865,2833,3087,708,375,167,558,2526,2474,368,879,691,3052,2165,1583,455,202,2794,2481,1334,285,2809,1544,3290,2371,3019,3307,855,2357,1141,611,483,2347,1703,208,2895,2346,1997,601,3021,2084,1704,2188,2165,333,2057,421,2664,3172,1346,3130,3276,71,1948,2538,2024,2515,1848,3323,685,2720,193,2874,68,2261,2842,1014,1567,2710,3172,3208,3120,1150,1113,749,1606,3099,2014,888,2315,2362,452,2182,2402,2319,2469,844,2880,1710,1347,142,536,2263,2868,734,654,2341,2442,2212,2523,2126,1773,2458,824,28,3000,2545,2194,2511,3129,2168,2745,103,2350,1725,1531,248,1347,1796,2435,3097,2003,873,2096,1767,55,2389,963,3100,1453,1493,3066,2329,1781,1673,1555,2889,2825,580,1343,1744,1420,45,900,1803,2381,1355,1184,331,277,1439,3203,3112,2290,217,1906,724,772,1360,2358,1688,2883,3179,3225,2963,2555,830,1199,1684,1732,3175,746,2279,1883,164,1530,800,2387,1939,2730,3143,3260,2086,3278,1159,2202,1563,247,962,718,2349,1459,97,2500,1567,1904,2471,1822,480,458,934,3299,1897,3203,1103,261,1414,3072,770,3298,2249,1709,765,2594,933,1515,2869,509,2858,518,1469,1094,1908,2008,1161,303,870,534,1179,909,1557,2010,1607,1975,1288,617,1478,563,1732,3288,3199,1506,2949,1888,2072,2767,2070,143,877,306,113,1552,920};
int16_t matrixD[256]={181, 1337, 3248, 1364, 2540, 793, 1371, 2228, 481, 45, 2299, 2128, 1559, 114, 1420, 3194, 3188, 1190, 2368, 2270, 530, 3094, 415, 3248, 2587, 2742, 802, 2771, 2280, 3015, 131, 893, 821, 1284, 1765, 262, 2765, 379, 1302, 2777, 2557, 1302, 3135, 719, 833, 1126, 57, 2651, 2346, 407, 2789, 3071, 46, 64, 1764, 2590, 2378, 1676, 2561, 1148, 879, 1191, 2507, 2832, 12, 894, 3318, 2182, 2441, 905, 423, 716, 3001, 1943, 1978, 2139, 515, 95, 3063, 875, 1837, 1909, 2452, 1804, 2543, 2258, 23, 2911, 2727, 1039, 1346, 2101, 1933, 840, 1168, 2465, 3105, 1339, 338, 2264, 2259, 999, 2448, 2404, 2861, 243, 1525, 1379, 2821, 252, 2369, 448, 2984, 1074, 2327, 3026, 1349, 1161, 2139, 1969, 2106, 2071, 1990, 3308, 1692, 2391, 3192, 2022, 1784, 732, 2419, 296, 486, 990, 2180, 2989, 681, 2731, 532, 1123, 486, 1129, 2584, 2203, 2361, 961, 417, 7, 2833, 2156, 1203, 3016, 2385, 308, 3126, 2697, 1390, 2586, 801, 313, 2132, 164, 316, 2408, 1418, 1544, 1446, 705, 2219, 2406, 1001, 1660, 2735, 2111, 173, 2427, 330, 1713, 973, 2979, 568, 846, 1378, 1454, 2003, 2540, 2009, 3257, 958, 892, 2860, 617, 2301, 438, 3097, 1906, 193, 1455, 3124, 2718, 3225, 3171, 777, 2408, 1179, 436, 3167, 1529, 2057, 12, 2522, 2700, 2269, 2029, 2029, 701, 134, 1991, 1621, 3022, 1778, 2115, 1309, 2625, 652, 1498, 3018, 1030, 3295, 2131, 1566, 1978, 13, 1022, 779, 1162, 2867, 1591, 1760, 926, 1292, 2408, 3102, 2431, 2499, 992, 3324, 2101, 693, 2998, 2699, 2265, 2040, 2042, 2606, 459};

int16_t roots[120] = {
	2285,1493,2970,287,2571,1422,1812,202,2285,2970,2571,1812,2285,2571,2285,1223,2036,2777,3047,652,1491,1015,1785,573,264,2004,383,3158,622,1493,573,2500,264,1727,2004,1458,383,3199,3158,1577,622,182,1493,1422,2970,2476,107,3058,3082,3239,1908,830,2378,2648,732,1017,608,962,2127,287,3158,962,1577,1855,622,2127,182,1468,1493,287,1422,202,2970,1812,2571,516,1711,3009,126,3321,2167,2663,1469,2500,1727,1458,3199,1577,182,1422,2648,1787,732,3124,1017,411,608,1758,962,1855,2127,1468,287,202,1812,2931,448,1821,677,961,2264,2604,2054,1787,3124,411,1758,1855,1468,202
	};

int16_t inv_roots[127] ={
	1571,1275,2652,1701,1807,1460,2371,205,1065,2881,2338,2333,308,108,2918,725,1508,2851,870,854,1510,1542,2368,398,2535,1278,1530,1185,2721,951,247,1659,1187,3109,874,2597,1421,3222,1335,2111,136,1215,2312,2499,271,2945,1465,1285,2007,681,90,853,2719,2726,2232,2512,130,1860,3203,75,156,3000,2911,1602,1162,1618,2980,872,2685,1590,1871,666,320,2210,602,1846,777,829,8,2813,147,2170,2551,246,2946,1544,282,1676,1755,460,291,3065,1838,1293,235,3152,2742,2907,1325,2314,552,3224,1779,2458,1251,2756,2677,2106,2486,2774,2899,1103,266,1517,359,3127,3042,1907,1836,1861,1474,1202,2367,3147,1752,2707,171
};

int16_t pairmul_roots[128] = {
	2226,1103,430,2899,555,2774,843,2486,2078,1251,871,2458,1550,1779,105,3224,422,2907,587,2742,177,3152,3094,235,3038,291,2869,460,1574,1755,1653,1676,3083,246,778,2551,1159,2170,3182,147,2552,777,1483,1846,2727,602,1119,2210,1739,1590,644,2685,2457,872,349,2980,418,2911,329,3000,3173,156,3254,75,817,2512,1097,2232,603,2726,610,2719,1322,2007,2044,1285,1864,1465,384,2945,2114,1215,3193,136,1218,2111,1994,1335,2455,874,220,3109,2142,1187,1670,1659,2144,1185,1799,1530,2051,1278,794,2535,1819,1510,2475,854,2459,870,478,2851,3221,108,3021,308,996,2333,991,2338,958,2371,1869,1460,1522,1807,1628,1701
};


//int16_t tmp1[256]={};
//int16_t tmp2[256]={};

int16_t twist[128] ={2285,2226,1223,817,573,3083,2476,2144,3158,422,516,2114,2648,1739,2931,3221,1493,2078,2036,1322,2500,2552,107,1819,962,3038,1711,2455,1787,418,448,958,2970,555,2777,603,264,1159,3058,2051,1577,177,3009,1218,732,2457,1821,996,287,1550,3047,1864,1727,2727,3082,2459,1855,1574,126,2142,3124,3173,677,1522,2571,430,652,1097,2004,778,3239,1799,622,587,3321,3193,1017,644,961,3021,1422,871,1491,2044,1458,1483,1908,2475,2127,2869,2167,220,411,329,2264,1869,1812,843,1015,610,383,3182,830,794,182,3094,2663,1994,608,349,2604,991,202,105,1785,384,3199,1119,2378,478,1468,1653,1469,1670,1758,3254,2054,1628};


unsigned int begin_twist, begin_ntt_ma, begin_ntt_mb, begin_basemul, begin_intt, begin_i_twist;
unsigned int end_twist, end_ntt_ma, end_ntt_mb, end_basemul, end_intt, end_i_twist;

extern void NTT_forward(int16_t * , int16_t *);
extern void NTT_backward(int16_t * , int16_t *);
extern void NTT_pre(int16_t *, int16_t *);
extern void NTT_inv_pre(int16_t *, int16_t *);
extern void BaseMul(int16_t *, int16_t *, int16_t *, int16_t *);


void main(void){
		int i;
			begin_twist = __get_rv_cycle();
			NTT_pre(matrixA, twist);
			end_twist = __get_rv_cycle();
			printf("cycle_count_twist is %d", end_twist - begin_twist);
			
			begin_ntt_ma =__get_rv_cycle();
	    		NTT_forward(matrixA, roots);
			end_ntt_ma =__get_rv_cycle();
			printf("cycle_count_ntt(MA) is %d", end_ntt_ma - begin_ntt_ma);
			
			NTT_pre(matrixB, twist);
                        
			begin_ntt_mb =__get_rv_cycle();
			NTT_forward(matrixB, roots);
			end_ntt_mb =__get_rv_cycle();
			printf("cycle_count_ntt(MB) is %d", end_ntt_mb - begin_ntt_mb);
			
			begin_basemul =__get_rv_cycle();
			BaseMul(matrixA,matrixB,pairmul_roots,matrixC);
			end_basemul =__get_rv_cycle();
			printf("cycle_count_Basemul is %d", end_basemul - begin_basemul);
			
			begin_intt =__get_rv_cycle();
			NTT_backward(matrixC, inv_roots);
			end_intt =__get_rv_cycle();
			printf("cycle_count_INTT is %d", end_intt - begin_intt);
			
			//begin_i_twist =__get_rv_cycle();
			//NTT_inv_pre(matrixC, inv_twist);
			//end_i_twist =__get_rv_cycle();
			//printf("cycle_count_Itwist is %d", end_i_twist - begin_i_twist);

			printf("******************************************************************\n");
			printf("*********************check_7-1*********************************************\n");
			for(i = 0; i < 256; i++){
				printf("%10d\t%10d,", i,matrixC[i]-matrixD[i]);
				printf("\n");
			}
		//int res; 
		//asm volatile(
		//"lw x10, %[src1]\t\n"
		//"lw x11, %[src2]\t\n"
		//"sub %[dest], x10, x11\t\n"
		//:[dest] "=r" (res)		
		//:[src1]"r"(matrixA[0]),[src2]"r"(matrixB[0])
		//:"x10","x11"
//);
}
